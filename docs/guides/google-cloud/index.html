<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.21-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>Google Cloud Deployment &middot; Funnel</title>
  

  
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/poole.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/monokai-sublime.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/syntax.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/theme.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/funnel.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://ohsu-comp-bio.github.io/funnel/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://ohsu-comp-bio.github.io/funnel/favicon.png">

  <script src="https://ohsu-comp-bio.github.io/funnel/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

  <div class="global-header">
    <div class="global-header-container">
      <div class="global-header-home">
        <a href="https://ohsu-comp-bio.github.io/funnel/"><h1>Funnel</h1></a>
      </div>
      <ul class="global-header-nav">
          <li><a href="https://ohsu-comp-bio.github.io/funnel/install/">Install</a></li>
          <li><a href="https://ohsu-comp-bio.github.io/funnel/docs/">Docs</a></li>
          <li><a href="https://github.com/ohsu-comp-bio/funnel">GitHub</a></li>
          <li><a href="https://gitter.im/ohsu-comp-bio/funnel">Chat</a></li>
        </ul>
      <div class="global-header-ohsucb">
        <a href="https://www.ohsu.edu/xd/education/schools/school-of-medicine/departments/computational-biology/"><h2>OHSU Comp. Bio.</h2></a>
      </div>
    </div>
  </div>


<div class="content section group">

  <div class="sidebar col span_3_of_12">
    <ul class="sidebar-nav">
      
      
        
        <li><a
          href="https://ohsu-comp-bio.github.io/funnel/docs/"
          class="sidebar-nav-item "
          >Overview</a></li>
          
        
        <li><a
          href="https://ohsu-comp-bio.github.io/funnel/install/"
          class="sidebar-nav-item "
          >Install</a></li>
          
        
        <li><a
          href="https://ohsu-comp-bio.github.io/funnel/docs/quickstart/"
          class="sidebar-nav-item "
          >Quickstart</a></li>
          
        
        <li><a
          href="https://ohsu-comp-bio.github.io/funnel/docs/config/"
          class="sidebar-nav-item "
          >Config</a></li>
          
        
        <li><a
          href="https://ohsu-comp-bio.github.io/funnel/docs/guides/"
          class="sidebar-nav-item "
          >Guides</a></li>
          
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/aws/"
                   class="sidebar-nav-item "
                >AWS Deployment</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/google-cloud/"
                   class="sidebar-nav-item  active"
                >Google Cloud Deployment</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/htcondor/"
                   class="sidebar-nav-item "
                >HTCondor</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/grid-engine/"
                   class="sidebar-nav-item "
                >Open Grid Engine</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/pbs-torque/"
                   class="sidebar-nav-item "
                >PBS/Torque</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/slurm/"
                   class="sidebar-nav-item "
                >SLURM</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/openstack/"
                   class="sidebar-nav-item "
                >OpenStack</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/guides/basic-auth/"
                   class="sidebar-nav-item "
                >Basic Auth</a></li>
            </ul>
          </li>
          
          
        
        <li><a
          href="https://ohsu-comp-bio.github.io/funnel/docs/development/"
          class="sidebar-nav-item "
          >Development</a></li>
          
        
        <li><a
          href="https://ohsu-comp-bio.github.io/funnel/docs/design/"
          class="sidebar-nav-item "
          >Design</a></li>
          
        
        <li><a
          href="https://godoc.org/github.com/ohsu-comp-bio/funnel"
          class="sidebar-nav-item "
          >Reference</a></li>
          
        
      
    </ul>
  </div>

  <div class="main col span_8_of_12">
    

<h1 id="google-cloud-compute">Google Cloud Compute</h1>

<p>This guide covers deploying a Funnel server and workers to <a href="https://cloud.google.com/compute/">Google Cloud Compute (GCE)</a>.
You&rsquo;ll need to create a Google Cloud project, and install the <a href="https://cloud.google.com/sdk/gcloud/">gcloud</a> SDK.
Optionally, these commands can be done through the GCE web dashboard.</p>

<h2 id="create-a-funnel-vm-image">Create a Funnel VM Image</h2>

<p>A Funnel <a href="https://cloud.google.com/compute/docs/images">image</a> provides the basic dependencies and configuration
needed by both Funnel servers and workers, and allows instances to start
more quickly and reliably.</p>

<p>Manually creating a GCE image can be tedious, but the Funnel <a href="https://github.com/ohsu-comp-bio/funnel/tree/master/deployments/gce/bundle">image installer</a>
makes it a little easier and automated.</p>

<pre><code class="language-bash">#!/bin/bash

INSTALLER='https://github.com/ohsu-comp-bio/funnel/releases/download/dev/bundle.run'

# Create a VM, download the installer, and run it.
# The installer will install dependencies and create an image.
gcloud compute instances create funnel-image-builder                \
  --scopes compute-rw                                               \
  --metadata &quot;startup-script-url=$INSTALLER,serial-port-enable=1&quot;

# Follow the logs
gcloud compute instances tail-serial-port-output $NAME
</code></pre>

<p>This takes a few minutes. The installer needs to create a VM instance,
snapshot, disk, and then finally an image. Images will be created in the
&ldquo;funnel&rdquo; <a href="https://cloud.google.com/compute/docs/images#image_families">image family</a>.</p>

<h2 id="create-a-server">Create a Server</h2>

<p>Now that you have an image, it&rsquo;s fairly easy to create a server:</p>

<pre><code class="language-bash">#!/bin/bash

gcloud compute instances create funnel-server \
  --scopes       'compute-rw,storage-rw'      \
  --zone         'us-west1-a'                 \
  --tags         'funnel,http-server'         \
  --image-family 'funnel'
</code></pre>

<h2>Create a Worker <i class="optional">optional</i></h2>

<pre><code class="language-bash">#!/bin/bash

# RPC address of the Funnel server.
FUNNEL_SERVER=&quot;funnel-server:9090&quot;

# Create a worker instance using the Funnel image.
gcloud compute instances create funnel-worker-1 \
  --scopes compute-rw,storage-rw                \
  --zone 'us-west1-a'                           \
  --tags funnel                                 \
  --image-family funnel                         \
  --machine-type 'n1-standard-16'               \
  --boot-disk-type 'pd-standard'                \
  --boot-disk-size '250GB'                      \
  --metadata &quot;funnel-worker-serveraddress=$FUNNEL_SERVER&quot;
</code></pre>

<h2>Create Worker Templates <i class="optional">optional</i></h2>

<p>Funnel includes a GCE autoscaler which can automatically start workers as needed.
Funnel uses <a href="https://cloud.google.com/compute/docs/instance-templates">instances templates</a> to describe the types of workers available.</p>

<p>The script below creates three templates for workers of various sizes:
1 CPU, 2 CPU, and 4 CPU.</p>

<pre><code class="language-bash">#!/bin/bash

# List of machine types to create templates for.
# https://cloud.google.com/compute/docs/machine-types
MACHINE_TYPES=&quot;
n1-standard-1
n1-standard-2
n1-standard-4
&quot;

for mt in $MACHINE_TYPES; do
  gcloud compute instance-templates create &quot;funnel-worker-$mt&quot; \
    --scopes compute-rw,storage-rw \
    --tags funnel \
    --image-family funnel \
    --machine-type $mt \
    --boot-disk-type 'pd-standard' \
    --boot-disk-size '250GB'
done
</code></pre>

<h1 id="custom-installations">Custom Installations</h1>

<p>This guide and the example code in Funnel is just the tip of the iceberg, really.</p>

  </div>

</div>
</body>
</html>
